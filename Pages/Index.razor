@page "/index/{pageNum:int?}"
@using MauiApp3.Common;
@using MauiApp3.Model;
@using System.Text.Encodings.Web;
@using System.Text;
@inject MauiApp3.Data.SoduService soduService;
@inject NavigationManager Navigation
@inject IJSRuntime js;
@if (novelPageInfo is null)
{
    <div class="btn-group container">
        <NavLink href="/" class="btn text-nowrap btn-sm btn-block btn-outline-primary">主页</NavLink>
        <NavLink href="/records" class="btn text-nowrap btn-sm btn-block btn-outline-primary">历史记录</NavLink>
    </div>
    <p><em>@Message</em></p>
}
else
{

    <div>
        <form>
            <div class="form-group mx-sm-3  mt-3">
                <input type="text" class="form-control mb-3" @bind="searchText" placeholder="输入小说名称">
                <button type="submit" class="btn btn-primary  float-end mr-2" @onclick=@(e=>Navigation.GoTo("/search",searchText)) @onclick:preventDefault>搜索</button>
            </div>

        </form>
    </div>
    <div class="d-flex flex-column bd-highlight mb-3"></div>
    <div class="p-2 bd-highlight">
        <p>当前页：@novelPageInfo.CurrentPage 总页数:@novelPageInfo.PageCount</p>
        <div class="btn-group container">
            <NavLink href="/" class="btn text-nowrap btn-sm btn-block btn-outline-primary">主页</NavLink>

            <NavLink href="/records" class="btn text-nowrap btn-sm btn-block btn-outline-primary">历史记录</NavLink>

            @if (novelPageInfo.CurrentPage > 1)
            {
                <a @onclick=@(e=>Navigation.GoTo("/index",(novelPageInfo.CurrentPage-1).ToString())) @onclick:preventDefault class="btn text-nowrap btn-sm btn-block btn-outline-primary">上一页</a>
            }
            @if (novelPageInfo.CurrentPage < novelPageInfo.PageCount)
            {
                <a @onclick=@(e=>Navigation.GoTo("/index",novelPageInfo.PageCount.ToString())) @onclick:preventDefault class="btn text-nowrap btn-sm btn-block btn-outline-primary ">尾页</a>
            }
            @if (novelPageInfo.CurrentPage < novelPageInfo.PageCount)
            {
                <a @onclick=@(e=>Navigation.GoTo("/index",(novelPageInfo.CurrentPage+1).ToString())) @onclick:preventDefault class="btn text-nowrap btn-sm btn-block btn-outline-primary">下一页</a>
            }
        </div>

    </div>
    <div class="p-2 bd-highlight">
        <ul>
            @if (novelPageInfo.Infos != null)
            {
                @foreach (var item in novelPageInfo.Infos)
                {


                    <li class="starter-template">
                        <h1><p class="lead" @onclick=@(e=>Navigation.GoTo("/detial",item.Url,item.NovleId,item.Name,item.Url))>@item.Name</p></h1>
                        <p>@item.LastChapter</p>
                        <p>@item.UpdateTime</p>
                    </li>
                }
            }

        </ul>
    </div>
    <div class="btn-group container mb-3">
        <NavLink href="/" class="btn btn-sm btn-block btn-outline-primary">主页</NavLink>
        <NavLink href="/records" class="btn text-nowrap btn-sm btn-block btn-outline-primary">历史记录</NavLink>
        @if (novelPageInfo.CurrentPage > 1)
        {
            <a @onclick=@(e=>Navigation.GoTo("/index",(novelPageInfo.CurrentPage-1).ToString())) @onclick:preventDefault class="btn text-nowrap btn-sm btn-block btn-outline-primary">上一页</a>
        }
        @if (novelPageInfo.CurrentPage < novelPageInfo.PageCount)
        {
            <a @onclick=@(e=>Navigation.GoTo("/index",novelPageInfo.PageCount.ToString())) @onclick:preventDefault class="btn text-nowrap btn-sm btn-block btn-outline-primary">尾页</a>
        }
        @if (novelPageInfo.CurrentPage < novelPageInfo.PageCount)
        {
            <a @onclick=@(e=>Navigation.GoTo("/index",(novelPageInfo.CurrentPage+1).ToString())) @onclick:preventDefault class="btn text-nowrap btn-sm btn-block btn-outline-primary">下一页</a>
        }
    </div>
    <div class="container">
        <div class="input-group mb-3 mt-2">
            <input type="text" class="form-control" placeholder="input page number" @bind=pageNum>
            <button class="btn btn-outline-primary" @onclick=@(e=>GoToPage()) id="button-addon2">跳转</button>
        </div>
    </div>




}

@code {
    [Parameter]
    public int? pageNum { get; set; }
    public string searchText { get; set; }
    private NovelPageInfo novelPageInfo;
    public string Message = "Loading";

    protected override async Task OnParametersSetAsync()
    {
        await js.InvokeVoidAsync("loading", true);
        try
        {
            novelPageInfo = await soduService.GetVisit(pageNum.HasValue ? pageNum.Value : 1);
        }
        catch (Exception ex)
        {
            StateHasChanged();
            Message = "发生错误" + ex.Message;
        }
        finally
        {
            await js.InvokeVoidAsync("loading", false);
        }


    }
    public void GoToPage()
    {
        if (pageNum != null && pageNum.Value != novelPageInfo.CurrentPage && pageNum.Value <= novelPageInfo.PageCount)
        {
            Navigation.GoTo("/index", pageNum.Value.ToString());
        }

    }
}
